<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Weekly Match Report - Referee Manager</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { 
            background-color: #f8f9fa; 
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        .header {
            background: linear-gradient(135deg, #1a237e, #283593);
            color: white;
            padding: 2rem 0;
            margin-bottom: 2rem;
            border-radius: 0 0 10px 10px;
        }
        .summary-card {
            border: none;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            transition: transform 0.3s;
            height: 100%;
        }
        .summary-card:hover {
            transform: translateY(-5px);
        }
        .summary-card.total { border-left: 4px solid #2196F3; }
        .summary-card.warning { border-left: 4px solid #FF9800; }
        .summary-card.urgent { border-left: 4px solid #F44336; }
        .summary-card.assigned { border-left: 4px solid #4CAF50; }
        
        .count {
            font-size: 2.5rem;
            font-weight: bold;
            margin: 0;
        }
        
        .match-row {
            transition: all 0.3s;
            border-left: 4px solid transparent;
        }
        .match-row.unassigned {
            border-left-color: #F44336;
            background-color: #ffebee;
        }
        .match-row.partially_assigned {
            border-left-color: #FF9800;
            background-color: #fff3e0;
        }
        .match-row.fully_assigned {
            border-left-color: #4CAF50;
            background-color: #e8f5e9;
        }
        
        .badge-status {
            padding: 5px 10px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
        }
        .badge-unassigned { background-color: #F44336; color: white; }
        .badge-partial { background-color: #FF9800; color: white; }
        .badge-assigned { background-color: #4CAF50; color: white; }
        
        .date-filter {
            background: white;
            padding: 1rem;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
            margin-bottom: 1.5rem;
        }
        
        .action-btn {
            padding: 5px 15px;
            font-size: 0.85rem;
        }
        
        .loading-spinner {
            display: none;
            text-align: center;
            padding: 2rem;
        }
    </style>
</head>
<body>
    <div class="header">
        <div class="container">
            <div class="row align-items-center">
                <div class="col-md-8">
                    <h1 class="display-5 fw-bold">ðŸ“Š Weekly Match Report</h1>
                    <p class="lead mb-0">Referee Assignments & Match Schedule Overview</p>
                </div>
                <div class="col-md-4 text-end">
                    <div class="btn-group" role="group">
                        <button class="btn btn-outline-light" onclick="loadLast7Days()">Last 7 Days</button>
                        <button class="btn btn-outline-light" onclick="loadNextWeek()">Next Week</button>
                        <button class="btn btn-outline-light" onclick="loadAllUpcoming()">All Upcoming</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="container">
        <!-- Date Filter -->
        <div class="date-filter">
            <div class="row align-items-center">
                <div class="col-md-4">
                    <h5 class="mb-0">Select Date Range</h5>
                </div>
                <div class="col-md-8">
                    <div class="row g-2">
                        <div class="col-md-4">
                            <input type="date" id="startDate" class="form-control" value="2025-12-24">
                        </div>
                        <div class="col-md-1 text-center">
                            <span class="mt-2 d-block">to</span>
                        </div>
                        <div class="col-md-4">
                            <input type="date" id="endDate" class="form-control" value="2026-01-18">
                        </div>
                        <div class="col-md-3">
                            <button class="btn btn-primary w-100" onclick="loadReport()">Generate Report</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Summary Cards -->
        <div class="row mb-4" id="summaryCards">
            <!-- Will be populated by JavaScript -->
        </div>

        <!-- Loading Spinner -->
        <div class="loading-spinner" id="loadingSpinner">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
            <p class="mt-2">Loading report data...</p>
        </div>

        <!-- Matches Table -->
        <div class="card shadow-sm">
            <div class="card-header bg-white d-flex justify-content-between align-items-center">
                <h5 class="mb-0">ðŸ“… Match Schedule</h5>
                <div>
                    <span class="badge bg-danger me-2" id="urgentCount">0 urgent</span>
                    <span class="text-muted" id="matchCount">0 matches</span>
                </div>
            </div>
            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="table table-hover mb-0">
                        <thead class="table-light">
                            <tr>
                                <th>Date</th>
                                <th>Time</th>
                                <th>Teams</th>
                                <th>Venue</th>
                                <th>Zone</th>
                                <th>Officials</th>
                                <th>Status</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="matchesTableBody">
                            <!-- Will be populated by JavaScript -->
                        </tbody>
                    </table>
                </div>
            </div>
            <div class="card-footer bg-white text-muted">
                <small>Last updated: <span id="lastUpdated">Just now</span></small>
            </div>
        </div>

        <!-- No Matches Message -->
        <div class="alert alert-info mt-4 d-none" id="noMatchesMessage">
            <h5>No matches found in the selected date range.</h5>
            <p>Try selecting a different date range or check if matches have been scheduled.</p>
        </div>
    </div>

    <script>
        // Format date to readable string
        function formatDate(dateString) {
            const date = new Date(dateString);
            return date.toLocaleDateString('en-US', { 
                weekday: 'short',
                month: 'short', 
                day: 'numeric',
                year: 'numeric'
            });
        }

        // Format time to 12-hour format
        function formatTime(timeString) {
            if (!timeString) return '';
            const [hours, minutes] = timeString.split(':');
            const hour = parseInt(hours);
            const ampm = hour >= 12 ? 'PM' : 'AM';
            const hour12 = hour % 12 || 12;
            return `${hour12}:${minutes} ${ampm}`;
        }

        // Get badge class based on assignment status
        function getBadgeClass(status) {
            switch(status) {
                case 'fully_assigned': return 'badge-assigned';
                case 'partially_assigned': return 'badge-partial';
                case 'unassigned': return 'badge-unassigned';
                default: return 'badge-secondary';
            }
        }

        // Get status text
        function getStatusText(status) {
            switch(status) {
                case 'fully_assigned': return 'Assigned';
                case 'partially_assigned': return 'Partial';
                case 'unassigned': return 'Unassigned';
                default: return status;
            }
        }

        // Load report with current date range
        async function loadReport() {
            const startDate = document.getElementById('startDate').value;
            const endDate = document.getElementById('endDate').value;
            
            showLoading(true);
            
            try {
                const response = await fetch(`/referees/api/generate-weekly-report/?start_date=${startDate}&end_date=${endDate}`);
                const data = await response.json();
                
                updateSummaryCards(data);
                updateMatchesTable(data);
                document.getElementById('lastUpdated').textContent = new Date().toLocaleTimeString();
                
                // Show/hide no matches message
                if (data.summary.total_matches === 0) {
                    document.getElementById('noMatchesMessage').classList.remove('d-none');
                } else {
                    document.getElementById('noMatchesMessage').classList.add('d-none');
                }
                
            } catch (error) {
                console.error('Error loading report:', error);
                alert('Error loading report. Please try again.');
            } finally {
                showLoading(false);
            }
        }

        // Update summary cards
        function updateSummaryCards(data) {
            const summaryCards = document.getElementById('summaryCards');
            const summary = data.summary;
            
            summaryCards.innerHTML = `
                <div class="col-md-3 mb-3">
                    <div class="card summary-card total">
                        <div class="card-body text-center">
                            <h6 class="text-muted mb-2">TOTAL MATCHES</h6>
                            <h2 class="count text-primary">${summary.total_matches}</h2>
                            <small class="text-muted">In selected period</small>
                        </div>
                    </div>
                </div>
                <div class="col-md-3 mb-3">
                    <div class="card summary-card assigned">
                        <div class="card-body text-center">
                            <h6 class="text-muted mb-2">FULLY ASSIGNED</h6>
                            <h2 class="count text-success">${summary.fully_assigned}</h2>
                            <small class="text-muted">Ready for match day</small>
                        </div>
                    </div>
                </div>
                <div class="col-md-3 mb-3">
                    <div class="card summary-card warning">
                        <div class="card-body text-center">
                            <h6 class="text-muted mb-2">NEEDS ATTENTION</h6>
                            <h2 class="count text-warning">${summary.partially_assigned + summary.unassigned}</h2>
                            <small class="text-muted">Require officials</small>
                        </div>
                    </div>
                </div>
                <div class="col-md-3 mb-3">
                    <div class="card summary-card urgent">
                        <div class="card-body text-center">
                            <h6 class="text-muted mb-2">OFFICIALS NEEDED</h6>
                            <h2 class="count text-danger">${summary.officials_needed.total}</h2>
                            <small class="text-muted">Refs: ${summary.officials_needed.referees}, ARs: ${summary.officials_needed.assistant_referee_1 + summary.officials_needed.assistant_referee_2}</small>
                        </div>
                    </div>
                </div>
            `;
        }

        // Update matches table
        function updateMatchesTable(data) {
            const tableBody = document.getElementById('matchesTableBody');
            const urgentCount = document.getElementById('urgentCount');
            const matchCount = document.getElementById('matchCount');
            
            let urgentMatches = 0;
            let tableHTML = '';
            
            data.matches.forEach(match => {
                if (match.needs_attention) urgentMatches++;
                
                const officials = match.officials;
                const officialsText = `
                    <strong>Ref:</strong> ${officials.referee || 'Not assigned'}<br>
                    <strong>AR1:</strong> ${officials.assistant_referee_1 || 'Not assigned'}<br>
                    <strong>AR2:</strong> ${officials.assistant_referee_2 || 'Not assigned'}
                `;
                
                tableHTML += `
                    <tr class="match-row ${match.assignment_status}">
                        <td>
                            <strong>${formatDate(match.date)}</strong>
                        </td>
                        <td>${formatTime(match.time)}</td>
                        <td>
                            <strong>${match.teams}</strong><br>
                            <small class="text-muted">${match.home_team.code} vs ${match.away_team.code}</small>
                        </td>
                        <td>${match.venue}</td>
                        <td><span class="badge bg-info">${match.zone}</span></td>
                        <td><small>${officialsText}</small></td>
                        <td>
                            <span class="badge-status ${getBadgeClass(match.assignment_status)}">
                                ${getStatusText(match.assignment_status)}
                            </span>
                        </td>
                        <td>
                            <button class="btn btn-sm btn-outline-primary action-btn" onclick="assignOfficials(${match.id})">
                                Assign
                            </button>
                            <button class="btn btn-sm btn-outline-secondary action-btn" onclick="viewMatch(${match.id})">
                                View
                            </button>
                        </td>
                    </tr>
                `;
            });
            
            tableBody.innerHTML = tableHTML;
            urgentCount.textContent = `${urgentMatches} urgent`;
            matchCount.textContent = `${data.matches.length} matches`;
        }

        // Show/hide loading spinner
        function showLoading(show) {
            document.getElementById('loadingSpinner').style.display = show ? 'block' : 'none';
            document.getElementById('summaryCards').style.display = show ? 'none' : 'block';
            document.querySelector('.card').style.display = show ? 'none' : 'block';
        }

        // Preset date ranges
        function loadLast7Days() {
            const end = new Date();
            const start = new Date();
            start.setDate(end.getDate() - 6);
            
            document.getElementById('startDate').value = start.toISOString().split('T')[0];
            document.getElementById('endDate').value = end.toISOString().split('T')[0];
            loadReport();
        }

        function loadNextWeek() {
            const start = new Date();
            const end = new Date();
            end.setDate(start.getDate() + 7);
            
            document.getElementById('startDate').value = start.toISOString().split('T')[0];
            document.getElementById('endDate').value = end.toISOString().split('T')[0];
            loadReport();
        }

        function loadAllUpcoming() {
            const start = new Date();
            const end = new Date();
            end.setMonth(start.getMonth() + 3);
            
            document.getElementById('startDate').value = start.toISOString().split('T')[0];
            document.getElementById('endDate').value = end.toISOString().split('T')[0];
            loadReport();
        }

        // Action functions
        function assignOfficials(matchId) {
            window.location.href = `/referees/match/${matchId}/appoint/`;
        }

        function viewMatch(matchId) {
            // You can implement match viewing logic here
            alert(`Viewing match ${matchId} - This would open match details`);
        }

        // Load initial report on page load
        document.addEventListener('DOMContentLoaded', function() {
            loadReport();
        });
    </script>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>